{
    "sourceFile": "components/leads/lead-page-client.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1741293331066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1741890926712,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,21 +6,48 @@\n import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\n import { LeadProfile } from '@/components/leads/lead-profile';\n import { LeadActivities } from '@/components/leads/lead-activities';\n import { Phone, MessageSquare, Mail, Calendar, FileText } from 'lucide-react';\n-import { leads } from '@/data/leads';\n+import { getLeadById } from '@/lib/services/leads-service';\n+import { Lead } from '@/data/leads';\n \n export function LeadPageClient() {\n   const params = useParams();\n   const searchParams = useSearchParams();\n   const leadId = params.id as string;\n   const isEditMode = searchParams.get('edit') === 'true';\n-  const [lead, setLead] = useState(leads.find(l => l.id.toString() === leadId));\n+  const [lead, setLead] = useState<Lead | null>(null);\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState<string | null>(null);\n \n-  if (!lead) {\n-    return <div>Lead not found</div>;\n+  useEffect(() => {\n+    async function fetchLead() {\n+      try {\n+        setLoading(true);\n+        const leadData = await getLeadById(leadId);\n+        setLead(leadData);\n+        if (!leadData) {\n+          setError('Lead not found');\n+        }\n+      } catch (err) {\n+        console.error('Error fetching lead:', err);\n+        setError('Failed to load lead data');\n+      } finally {\n+        setLoading(false);\n+      }\n+    }\n+\n+    fetchLead();\n+  }, [leadId]);\n+\n+  if (loading) {\n+    return <div className=\"p-8 text-center\">Loading lead data...</div>;\n   }\n \n+  if (error || !lead) {\n+    return <div className=\"p-8 text-center text-red-500\">{error || 'Lead not found'}</div>;\n+  }\n+\n   return (\n     <div className=\"min-h-screen bg-background p-8\">\n       <motion.div\n         initial={{ opacity: 0 }}\n"
                },
                {
                    "date": 1743708237334,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,11 +5,13 @@\n import { motion } from 'framer-motion';\n import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\n import { LeadProfile } from '@/components/leads/lead-profile';\n import { LeadActivities } from '@/components/leads/lead-activities';\n+import { PipelineProgress } from '@/components/leads/pipeline-progress';\n import { Phone, MessageSquare, Mail, Calendar, FileText } from 'lucide-react';\n import { getLeadById } from '@/lib/services/leads-service';\n import { Lead } from '@/data/leads';\n+import { differenceInCalendarDays } from 'date-fns';\n \n export function LeadPageClient() {\n   const params = useParams();\n   const searchParams = useSearchParams();\n@@ -23,10 +25,14 @@\n     async function fetchLead() {\n       try {\n         setLoading(true);\n         const leadData = await getLeadById(leadId);\n-        setLead(leadData);\n-        if (!leadData) {\n+        \n+        // Calculate days in each stage if not already present\n+        const leadWithDays = calculateDaysInStage(leadData);\n+        \n+        setLead(leadWithDays);\n+        if (!leadWithDays) {\n           setError('Lead not found');\n         }\n       } catch (err) {\n         console.error('Error fetching lead:', err);\n@@ -37,8 +43,53 @@\n     }\n \n     fetchLead();\n   }, [leadId]);\n+  \n+  // Calculate days spent in each pipeline stage\n+  const calculateDaysInStage = (leadData: Lead | null): Lead | null => {\n+    if (!leadData) return null;\n+    \n+    // If no statusUpdatedAt, use createdAt as a fallback\n+    const statusDate = leadData.statusUpdatedAt || leadData.createdAt;\n+    const currentStage = leadData.status;\n+    \n+    // Calculate days in current stage\n+    const daysInCurrentStage = differenceInCalendarDays(\n+      new Date(),\n+      new Date(statusDate)\n+    );\n+    \n+    // Update the daysInStage record\n+    const daysInStage = leadData.daysInStage || {};\n+    \n+    return {\n+      ...leadData,\n+      daysInStage: {\n+        ...daysInStage,\n+        [currentStage]: Math.max(daysInCurrentStage, 0) // Ensure non-negative\n+      }\n+    };\n+  };\n+  \n+  // Handle status updates from pipeline component\n+  const handleStatusUpdate = (newStatus: string) => {\n+    if (!lead) return;\n+    \n+    // Update the lead object with new status\n+    const updatedLead = {\n+      ...lead,\n+      status: newStatus,\n+      statusUpdatedAt: new Date().toISOString(),\n+      // Reset days in new stage to 0\n+      daysInStage: {\n+        ...(lead.daysInStage || {}),\n+        [newStatus]: 0\n+      }\n+    };\n+    \n+    setLead(updatedLead);\n+  };\n \n   if (loading) {\n     return <div className=\"p-8 text-center\">Loading lead data...</div>;\n   }\n@@ -48,8 +99,13 @@\n   }\n \n   return (\n     <div className=\"min-h-screen bg-background p-8\">\n+      {/* Pipeline Progress Bar - Full Width */}\n+      <div className=\"mb-8\">\n+        <PipelineProgress lead={lead} onStatusUpdate={handleStatusUpdate} />\n+      </div>\n+      \n       <motion.div\n         initial={{ opacity: 0 }}\n         animate={{ opacity: 1 }}\n         className=\"grid grid-cols-12 gap-8\"\n"
                }
            ],
            "date": 1741293331066,
            "name": "Commit-0",
            "content": "\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { useParams, useSearchParams } from 'next/navigation';\nimport { motion } from 'framer-motion';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { LeadProfile } from '@/components/leads/lead-profile';\nimport { LeadActivities } from '@/components/leads/lead-activities';\nimport { Phone, MessageSquare, Mail, Calendar, FileText } from 'lucide-react';\nimport { leads } from '@/data/leads';\n\nexport function LeadPageClient() {\n  const params = useParams();\n  const searchParams = useSearchParams();\n  const leadId = params.id as string;\n  const isEditMode = searchParams.get('edit') === 'true';\n  const [lead, setLead] = useState(leads.find(l => l.id.toString() === leadId));\n\n  if (!lead) {\n    return <div>Lead not found</div>;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background p-8\">\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        className=\"grid grid-cols-12 gap-8\"\n      >\n        {/* Left Column - Lead Profile */}\n        <div className=\"col-span-3\">\n          <LeadProfile lead={lead} isEditMode={isEditMode} />\n        </div>\n\n        {/* Right Column - Activities */}\n        <div className=\"col-span-9\">\n          <Tabs defaultValue=\"phone\" className=\"w-full\">\n            <TabsList className=\"w-full justify-start\">\n              <TabsTrigger value=\"phone\">\n                <Phone className=\"w-4 h-4 mr-2\" />\n                Phone\n              </TabsTrigger>\n              <TabsTrigger value=\"notes\">\n                <MessageSquare className=\"w-4 h-4 mr-2\" />\n                Notes\n              </TabsTrigger>\n              <TabsTrigger value=\"email\">\n                <Mail className=\"w-4 h-4 mr-2\" />\n                Email\n              </TabsTrigger>\n              <TabsTrigger value=\"meetings\">\n                <Calendar className=\"w-4 h-4 mr-2\" />\n                Meetings\n              </TabsTrigger>\n              <TabsTrigger value=\"documents\">\n                <FileText className=\"w-4 h-4 mr-2\" />\n                Documents\n              </TabsTrigger>\n            </TabsList>\n\n            <LeadActivities leadId={leadId} />\n          </Tabs>\n        </div>\n      </motion.div>\n    </div>\n  );\n}"
        }
    ]
}